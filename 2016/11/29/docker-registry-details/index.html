<!DOCTYPE html>
<html lang="zh-cn">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="如果你有一下需求，请阅读本文：

想要理解Docker Registry V2认证机制
想要根据自己的业务构建企业级镜像仓库
想要理解Haboar这类工具的实现方式，不甘只是工具的使用者


当然文章的内容虽然也有参考价值，但是如果能自己阅读参考文献的内容显然意义更大。文章只是作为记录

Docke">
    

    <!--Author-->
    
        <meta name="author" content="云龙">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Docker Registry V2浅析"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="I&#39;m yunlong"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Docker Registry V2浅析 - I&#39;m yunlong</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Peaceful</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                博客
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/yunlzheng">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('http://7xj61w.com1.z0.glb.clouddn.com/header-bg-1.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Docker Registry V2浅析</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        2016-11-29
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/docker/">#docker</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>如果你有一下需求，请阅读本文：</p>
<ul>
<li>想要理解Docker Registry V2认证机制</li>
<li>想要根据自己的业务构建企业级镜像仓库</li>
<li>想要理解Haboar这类工具的实现方式，不甘只是工具的使用者</li>
</ul>
<blockquote>
<p>当然文章的内容虽然也有参考价值，但是如果能自己阅读参考文献的内容显然意义更大。文章只是作为记录</p>
</blockquote>
<h2 id="Docker-Registry-V2的认证过程"><a href="#Docker-Registry-V2的认证过程" class="headerlink" title="Docker Registry V2的认证过程"></a>Docker Registry V2的认证过程</h2><p>首先我们来了解一下当我们尝试从docker registry拉取镜像时实际的流程是什么样的？如下图所示</p>
<p><img src="http://7pn5d3.com1.z0.glb.clouddn.com/registry_v2_auth_server.png" alt=""></p>
<ol>
<li>docker daemon尝试从docker registry拉取镜像；</li>
<li>如果docker registry需要进行授权时，registry将会放回401 Unauthorized响应，同时在返回的头信息中包含了docker client如何进行认证的信息</li>
<li>docker client根据registry返回的信息，向auth server发送请求获取认证token</li>
<li>auth server则根据自己的业务实现去验证提交的用户信息查询用户数据仓库中是否存在相关信息（数据库或者LDAP）</li>
<li>用户数据仓库返回用户的相关信息</li>
<li>auth server将会根据查询的用户信息，生成token令牌，以及当前用户所具有的相关权限信息</li>
<li>docker client携带auth server返回的token令牌再次尝试访问docker registry.</li>
<li>docker registry验证用户提交的token令牌信息，通过后则开始镜像的pull或者push动作</li>
</ol>
<h2 id="配置并启用Docker-Registry启用用户认证"><a href="#配置并启用Docker-Registry启用用户认证" class="headerlink" title="配置并启用Docker Registry启用用户认证"></a>配置并启用Docker Registry启用用户认证</h2><p>默认情况下docker registry将会从/etc/docker/registry/config.yml读取所有的配置信息。</p>
<p>完整的registry配置信息如下：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">version:</span> <span class="number">0.1</span></div><div class="line"><span class="symbol">log:</span></div><div class="line"><span class="symbol">  level:</span> debug</div><div class="line"><span class="symbol">  formatter:</span> text</div><div class="line"><span class="symbol">  fields:</span></div><div class="line"><span class="symbol">    service:</span> registry</div><div class="line"><span class="symbol">    environment:</span> staging</div><div class="line"><span class="symbol">  hooks:</span></div><div class="line">    - type: mail</div><div class="line"><span class="symbol">      disabled:</span> true</div><div class="line"><span class="symbol">      levels:</span></div><div class="line">        - panic</div><div class="line"><span class="symbol">      options:</span></div><div class="line"><span class="symbol">        smtp:</span></div><div class="line"><span class="symbol">          addr:</span> mail.example.com:<span class="number">25</span></div><div class="line"><span class="symbol">          username:</span> mailuser</div><div class="line"><span class="symbol">          password:</span> password</div><div class="line"><span class="symbol">          insecure:</span> true</div><div class="line"><span class="symbol">        from:</span> sender@example.com</div><div class="line"><span class="symbol">        to:</span></div><div class="line">          - errors@example.com</div><div class="line"><span class="symbol">loglevel:</span> debug <span class="meta"># deprecated: use <span class="string">"log"</span></span></div><div class="line"><span class="symbol">storage:</span></div><div class="line"><span class="symbol">  filesystem:</span></div><div class="line"><span class="symbol">    rootdirectory:</span> <span class="meta-keyword">/var/</span>lib/registry</div><div class="line"><span class="symbol">	maxthreads:</span> <span class="number">100</span></div><div class="line"><span class="symbol">  azure:</span></div><div class="line"><span class="symbol">    accountname:</span> accountname</div><div class="line"><span class="symbol">    accountkey:</span> base64encodedaccountkey</div><div class="line"><span class="symbol">    container:</span> containername</div><div class="line"><span class="symbol">  gcs:</span></div><div class="line"><span class="symbol">    bucket:</span> bucketname</div><div class="line"><span class="symbol">    keyfile:</span> <span class="meta-keyword">/path/</span>to/keyfile</div><div class="line"><span class="symbol">    rootdirectory:</span> <span class="meta-keyword">/gcs/</span>object<span class="meta-keyword">/name/</span>prefix</div><div class="line"><span class="symbol">    chunksize:</span> <span class="number">5242880</span></div><div class="line"><span class="symbol">  s3:</span></div><div class="line"><span class="symbol">    accesskey:</span> awsaccesskey</div><div class="line"><span class="symbol">    secretkey:</span> awssecretkey</div><div class="line"><span class="symbol">    region:</span> us-west<span class="number">-1</span></div><div class="line"><span class="symbol">    regionendpoint:</span> http:<span class="comment">//myobjects.local</span></div><div class="line"><span class="symbol">    bucket:</span> bucketname</div><div class="line"><span class="symbol">    encrypt:</span> true</div><div class="line"><span class="symbol">    keyid:</span> mykeyid</div><div class="line"><span class="symbol">    secure:</span> true</div><div class="line"><span class="symbol">    v4auth:</span> true</div><div class="line"><span class="symbol">    chunksize:</span> <span class="number">5242880</span></div><div class="line"><span class="symbol">    rootdirectory:</span> <span class="meta-keyword">/s3/</span>object<span class="meta-keyword">/name/</span>prefix</div><div class="line"><span class="symbol">  swift:</span></div><div class="line"><span class="symbol">    username:</span> username</div><div class="line"><span class="symbol">    password:</span> password</div><div class="line"><span class="symbol">    authurl:</span> https:<span class="comment">//storage.myprovider.com/auth/v1.0 or https://storage.myprovider.com/v2.0 or https://storage.myprovider.com/v3/auth</span></div><div class="line"><span class="symbol">    tenant:</span> tenantname</div><div class="line"><span class="symbol">    tenantid:</span> tenantid</div><div class="line"><span class="symbol">    domain:</span> domain name for Openstack Identity v3 API</div><div class="line"><span class="symbol">    domainid:</span> domain id for Openstack Identity v3 API</div><div class="line"><span class="symbol">    insecureskipverify:</span> true</div><div class="line"><span class="symbol">    region:</span> fr</div><div class="line"><span class="symbol">    container:</span> containername</div><div class="line"><span class="symbol">    rootdirectory:</span> <span class="meta-keyword">/swift/</span>object<span class="meta-keyword">/name/</span>prefix</div><div class="line"><span class="symbol">  oss:</span></div><div class="line"><span class="symbol">    accesskeyid:</span> accesskeyid</div><div class="line"><span class="symbol">    accesskeysecret:</span> accesskeysecret</div><div class="line"><span class="symbol">    region:</span> OSS region name</div><div class="line"><span class="symbol">    endpoint:</span> optional endpoints</div><div class="line"><span class="symbol">    internal:</span> optional internal endpoint</div><div class="line"><span class="symbol">    bucket:</span> OSS bucket</div><div class="line"><span class="symbol">    encrypt:</span> optional data encryption setting</div><div class="line"><span class="symbol">    secure:</span> optional ssl setting</div><div class="line"><span class="symbol">    chunksize:</span> optional size valye</div><div class="line"><span class="symbol">    rootdirectory:</span> optional root directory</div><div class="line"><span class="symbol">  inmemory:</span>  <span class="meta"># This driver takes no parameters</span></div><div class="line"><span class="symbol">  delete:</span></div><div class="line"><span class="symbol">    enabled:</span> false</div><div class="line"><span class="symbol">  redirect:</span></div><div class="line"><span class="symbol">    disable:</span> false</div><div class="line"><span class="symbol">  cache:</span></div><div class="line"><span class="symbol">    blobdescriptor:</span> redis</div><div class="line"><span class="symbol">  maintenance:</span></div><div class="line"><span class="symbol">    uploadpurging:</span></div><div class="line"><span class="symbol">      enabled:</span> true</div><div class="line"><span class="symbol">      age:</span> <span class="number">168</span>h</div><div class="line"><span class="symbol">      interval:</span> <span class="number">24</span>h</div><div class="line"><span class="symbol">      dryrun:</span> false</div><div class="line"><span class="symbol">    readonly:</span></div><div class="line"><span class="symbol">      enabled:</span> false</div><div class="line"><span class="symbol">auth:</span></div><div class="line"><span class="symbol">  silly:</span></div><div class="line"><span class="symbol">    realm:</span> silly-realm</div><div class="line"><span class="symbol">    service:</span> silly-service</div><div class="line"><span class="symbol">  token:</span></div><div class="line"><span class="symbol">    realm:</span> token-realm</div><div class="line"><span class="symbol">    service:</span> token-service</div><div class="line"><span class="symbol">    issuer:</span> registry-token-issuer</div><div class="line"><span class="symbol">    rootcertbundle:</span> <span class="meta-keyword">/root/</span>certs/bundle</div><div class="line"><span class="symbol">  htpasswd:</span></div><div class="line"><span class="symbol">    realm:</span> basic-realm</div><div class="line"><span class="symbol">    path:</span> <span class="meta-keyword">/path/</span>to/htpasswd</div><div class="line"><span class="symbol">middleware:</span></div><div class="line"><span class="symbol">  registry:</span></div><div class="line">    - name: ARegistryMiddleware</div><div class="line"><span class="symbol">      options:</span></div><div class="line"><span class="symbol">        foo:</span> bar</div><div class="line"><span class="symbol">  repository:</span></div><div class="line">    - name: ARepositoryMiddleware</div><div class="line"><span class="symbol">      options:</span></div><div class="line"><span class="symbol">        foo:</span> bar</div><div class="line"><span class="symbol">  storage:</span></div><div class="line">    - name: cloudfront</div><div class="line"><span class="symbol">      options:</span></div><div class="line"><span class="symbol">        baseurl:</span> https:<span class="comment">//my.cloudfronted.domain.com/</span></div><div class="line"><span class="symbol">        privatekey:</span> <span class="meta-keyword">/path/</span>to/pem</div><div class="line"><span class="symbol">        keypairid:</span> cloudfrontkeypairid</div><div class="line"><span class="symbol">        duration:</span> <span class="number">3000</span>s</div><div class="line"><span class="symbol">  storage:</span></div><div class="line">    - name: redirect</div><div class="line"><span class="symbol">      options:</span></div><div class="line"><span class="symbol">        baseurl:</span> https:<span class="comment">//example.com/</span></div><div class="line"><span class="symbol">reporting:</span></div><div class="line"><span class="symbol">  bugsnag:</span></div><div class="line"><span class="symbol">    apikey:</span> bugsnagapikey</div><div class="line"><span class="symbol">    releasestage:</span> bugsnagreleasestage</div><div class="line"><span class="symbol">    endpoint:</span> bugsnagendpoint</div><div class="line"><span class="symbol">  newrelic:</span></div><div class="line"><span class="symbol">    licensekey:</span> newreliclicensekey</div><div class="line"><span class="symbol">    name:</span> newrelicname</div><div class="line"><span class="symbol">    verbose:</span> true</div><div class="line"><span class="symbol">http:</span></div><div class="line"><span class="symbol">  addr:</span> localhost:<span class="number">5000</span></div><div class="line"><span class="symbol">  prefix:</span> <span class="meta-keyword">/my/</span>nested<span class="meta-keyword">/registry/</span></div><div class="line"><span class="symbol">  host:</span> https:<span class="comment">//myregistryaddress.org:5000</span></div><div class="line"><span class="symbol">  secret:</span> asecretforlocaldevelopment</div><div class="line"><span class="symbol">  relativeurls:</span> false</div><div class="line"><span class="symbol">  tls:</span></div><div class="line"><span class="symbol">    certificate:</span> <span class="meta-keyword">/path/</span>to<span class="meta-keyword">/x509/</span>public</div><div class="line"><span class="symbol">    key:</span> <span class="meta-keyword">/path/</span>to<span class="meta-keyword">/x509/</span>private</div><div class="line"><span class="symbol">    clientcas:</span></div><div class="line">      - <span class="meta-keyword">/path/</span>to/ca.pem</div><div class="line">      - <span class="meta-keyword">/path/</span>to<span class="meta-keyword">/another/</span>ca.pem</div><div class="line"><span class="symbol">    letsencrypt:</span></div><div class="line"><span class="symbol">      cachefile:</span> <span class="meta-keyword">/path/</span>to/cache-file</div><div class="line"><span class="symbol">      email:</span> emailused@letsencrypt.com</div><div class="line"><span class="symbol">  debug:</span></div><div class="line"><span class="symbol">    addr:</span> localhost:<span class="number">5001</span></div><div class="line"><span class="symbol">  headers:</span></div><div class="line">    X-Content-Type-Options: [nosniff]</div><div class="line"><span class="symbol">notifications:</span></div><div class="line"><span class="symbol">  endpoints:</span></div><div class="line">    - name: alistener</div><div class="line"><span class="symbol">      disabled:</span> false</div><div class="line"><span class="symbol">      url:</span> https:<span class="comment">//my.listener.com/event</span></div><div class="line"><span class="symbol">      headers:</span> <span class="params">&lt;http.Header&gt;</span></div><div class="line"><span class="symbol">      timeout:</span> <span class="number">500</span></div><div class="line"><span class="symbol">      threshold:</span> <span class="number">5</span></div><div class="line"><span class="symbol">      backoff:</span> <span class="number">1000</span></div><div class="line"><span class="symbol">redis:</span></div><div class="line"><span class="symbol">  addr:</span> localhost:<span class="number">6379</span></div><div class="line"><span class="symbol">  password:</span> asecret</div><div class="line"><span class="symbol">  db:</span> <span class="number">0</span></div><div class="line"><span class="symbol">  dialtimeout:</span> <span class="number">10</span>ms</div><div class="line"><span class="symbol">  readtimeout:</span> <span class="number">10</span>ms</div><div class="line"><span class="symbol">  writetimeout:</span> <span class="number">10</span>ms</div><div class="line"><span class="symbol">  pool:</span></div><div class="line"><span class="symbol">    maxidle:</span> <span class="number">16</span></div><div class="line"><span class="symbol">    maxactive:</span> <span class="number">64</span></div><div class="line"><span class="symbol">    idletimeout:</span> <span class="number">300</span>s</div><div class="line"><span class="symbol">health:</span></div><div class="line"><span class="symbol">  storagedriver:</span></div><div class="line"><span class="symbol">    enabled:</span> true</div><div class="line"><span class="symbol">    interval:</span> <span class="number">10</span>s</div><div class="line"><span class="symbol">    threshold:</span> <span class="number">3</span></div><div class="line"><span class="symbol">  file:</span></div><div class="line">    - file: <span class="meta-keyword">/path/</span>to<span class="meta-keyword">/checked/</span>file</div><div class="line"><span class="symbol">      interval:</span> <span class="number">10</span>s</div><div class="line"><span class="symbol">  http:</span></div><div class="line">    - uri: http:<span class="comment">//server.to.check/must/return/200</span></div><div class="line"><span class="symbol">      headers:</span></div><div class="line"><span class="symbol">        Authorization:</span> [Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==]</div><div class="line"><span class="symbol">      statuscode:</span> <span class="number">200</span></div><div class="line"><span class="symbol">      timeout:</span> <span class="number">3</span>s</div><div class="line"><span class="symbol">      interval:</span> <span class="number">10</span>s</div><div class="line"><span class="symbol">      threshold:</span> <span class="number">3</span></div><div class="line"><span class="symbol">  tcp:</span></div><div class="line">    - addr: redis-server.domain.com:<span class="number">6379</span></div><div class="line"><span class="symbol">      timeout:</span> <span class="number">3</span>s</div><div class="line"><span class="symbol">      interval:</span> <span class="number">10</span>s</div><div class="line"><span class="symbol">      threshold:</span> <span class="number">3</span></div><div class="line"><span class="symbol">proxy:</span></div><div class="line"><span class="symbol">  remoteurl:</span> https:<span class="comment">//registry-1.docker.io</span></div><div class="line"><span class="symbol">  username:</span> [username]</div><div class="line"><span class="symbol">  password:</span> [password]</div><div class="line"><span class="symbol">compatibility:</span></div><div class="line"><span class="symbol">  schema1:</span></div><div class="line"><span class="symbol">    signingkeyfile:</span> <span class="meta-keyword">/etc/</span>registry/key.json</div></pre></td></tr></table></figure>
<p>在本文当中我们主要关注auth部分配置</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">auth:</span></div><div class="line"><span class="symbol">  silly:</span></div><div class="line"><span class="symbol">    realm:</span> silly-realm</div><div class="line"><span class="symbol">    service:</span> silly-service</div><div class="line"><span class="symbol">  token:</span></div><div class="line"><span class="symbol">    realm:</span> token-realm</div><div class="line"><span class="symbol">    service:</span> token-service</div><div class="line"><span class="symbol">    issuer:</span> registry-token-issuer</div><div class="line"><span class="symbol">    rootcertbundle:</span> <span class="meta-keyword">/root/</span>certs/bundle</div><div class="line"><span class="symbol">  htpasswd:</span></div><div class="line"><span class="symbol">    realm:</span> basic-realm</div><div class="line"><span class="symbol">    path:</span> <span class="meta-keyword">/path/</span>to/htpasswd</div></pre></td></tr></table></figure>
<p>auth配置部分是可选的，docker registry当前支持3种认证实现方式：silly，token，htpasswd;registry默认不开启auth配置。用户可以自定义其中一种实现来完成registry的认证配置。</p>
<p>我们有两种方式可以实现自定义配置：</p>
<ol>
<li>创建新的config.xml,并覆盖默认配置</li>
</ol>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker run -d -<span class="selector-tag">p</span> <span class="number">5000</span>:<span class="number">5000</span> --restart=always --name registry \</div><div class="line">  -v `pwd`/config<span class="selector-class">.yml</span>:/etc/docker/registry/config<span class="selector-class">.yml</span> \</div><div class="line">  registry:<span class="number">2</span></div></pre></td></tr></table></figure>
<ol>
<li>使用环境变量覆盖默认registry配置，以docker-compose为例：</li>
</ol>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">registry:</div><div class="line">  ports:</div><div class="line">    -<span class="ruby"> <span class="number">5000</span><span class="symbol">:</span><span class="number">5000</span>/tcp</span></div><div class="line">  image: registry:2</div><div class="line">  volumes:</div><div class="line">    -<span class="ruby"> <span class="string">"./certs:/certs:ro"</span></span></div><div class="line">    -<span class="ruby"> <span class="string">"./registry/storage:/var/lib/registry:rw"</span></span></div><div class="line">  environment:</div><div class="line">    -<span class="ruby"> REGISTRY_AUTH=token</span></div><div class="line">    -<span class="ruby"> REGISTRY_AUTH_TOKEN_REALM=<span class="symbol">http:</span>/<span class="regexp">/172.16.137.217:8080/auth</span></span></div><div class="line">    -<span class="ruby"> REGISTRY_AUTH_TOKEN_SERVICE=<span class="string">"Docker registry"</span></span></div><div class="line">    -<span class="ruby"> REGISTRY_AUTH_TOKEN_ISSUER=<span class="string">"Auth Service"</span></span></div><div class="line">    -<span class="ruby"> REGISTRY_HTTP_SECRET=secretkey</span></div><div class="line">    -<span class="ruby"> REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE=<span class="regexp">/certs/auth</span>.crt</span></div><div class="line">    -<span class="ruby"> REGISTRY_LOG_LEVEL=debug</span></div></pre></td></tr></table></figure>
<p>为了实现registry与业务系统的集成，我们配置registry auth的实现方式为token</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">auth:</span></div><div class="line"><span class="symbol">  token:</span></div><div class="line"><span class="symbol">    realm:</span> http:<span class="comment">//172.16.137.217:8080/auth</span></div><div class="line"><span class="symbol">    service:</span> Docker registry</div><div class="line"><span class="symbol">    issuer:</span> Auth Service</div><div class="line"><span class="symbol">    rootcertbundle:</span> <span class="meta-keyword">/certs/</span>auth.crt</div></pre></td></tr></table></figure>
<ul>
<li>auth.token.realm: auth server用于认证的Endpoint地址</li>
<li>auth.token.service: 用于请求auth server的携带的service名称</li>
<li>auth.token.issuer: registry信任的auth server名称</li>
<li>auth.token.rootcertbundle: 用户验证token签名的公钥文件</li>
</ul>
<blockquote>
<p>其中auth.crt为使用openssl生成的公钥文件，用于registry验证token的合法性</p>
</blockquote>
<p>以以上配置为例，我们来看看registry与auth server的实际交互过程：</p>
<p>例如当用户尝试向registry push镜像samalba/my-app时，为了完成当前操作，用户需要对repository samalba/my-app具有push的权限，registry将会返回401 Unuthorized信息</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 <span class="number">401</span> Unauthorized</div><div class="line"><span class="attribute">Content-Type</span>: application/json; charset=utf-8</div><div class="line"><span class="attribute">Docker-Distribution-Api-Version</span>: registry/2.0</div><div class="line"><span class="attribute">Www-Authenticate</span>: Bearer realm="http://172.16.137.217:8080/auth",service="Docker registry",scope="repository:samalba/my-app:pull,push"</div><div class="line"><span class="attribute">Date</span>: Thu, 10 Sep 2015 19:32:31 GMT</div><div class="line"><span class="attribute">Content-Length</span>: 235</div><div class="line"><span class="attribute">Strict-Transport-Security</span>: max-age=31536000</div><div class="line"></div><div class="line"><span class="json">&#123;<span class="attr">"errors"</span>:[&#123;<span class="attr">"code"</span>:<span class="string">"UNAUTHORIZED"</span>,<span class="attr">"message"</span>:<span class="string">"access to the requested resource is not authorized"</span>,<span class="attr">"detail"</span>:[&#123;<span class="attr">"Type"</span>:<span class="string">"repository"</span>,<span class="attr">"Name"</span>:<span class="string">"samalba/my-app"</span>,<span class="attr">"Action"</span>:<span class="string">"pull"</span>&#125;,&#123;<span class="attr">"Type"</span>:<span class="string">"repository"</span>,<span class="attr">"Name"</span>:<span class="string">"samalba/my-app"</span>,<span class="attr">"Action"</span>:<span class="string">"push"</span>&#125;]&#125;]&#125;</span></div></pre></td></tr></table></figure>
<p>其中需要注意的内容是：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">Www</span>-Authenticate: <span class="keyword">Bearer </span>realm=<span class="string">"http://172.16.137.217:8080/auth"</span>,service=<span class="string">"Docker registry"</span>,scope=<span class="string">"repository:samalba/my-app:pull,push"</span></div></pre></td></tr></table></figure>
<p>这里registry告诉docker client你需要从<a href="http://172.16.137.217:8080/auth获取认证信息，并且携带请求参数service以及scope" target="_blank" rel="external">http://172.16.137.217:8080/auth获取认证信息，并且携带请求参数service以及scope</a></p>
<blockquote>
<p>返回信息根据用户设置的auth配置产生</p>
</blockquote>
<p>Docker Client提供用户输入用户名和密码后向auth server的Endpoint发送请求：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">http:</span>//<span class="number">172.16</span><span class="meta">.137</span><span class="meta">.217</span>:<span class="number">8080</span>/auth?service=Docker registry&amp;scope=repository:samalba/my-app:pull,<span class="keyword">push</span></div></pre></td></tr></table></figure>
<p>同时在http head中包含用户相关的登录信息</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">authorized</span>: <span class="keyword">Basic </span>YWtaW46cGzc3dvmcQ=</div></pre></td></tr></table></figure>
<p>此时我们自己实现的auth server只需要从http head中通过base64获取登录的用户名和密码，并且验证登录信息的合法性，同时根据业务数据返回用户的实际权限(pull, push)即可.</p>
<p>基于JWT协议规范使用私钥对返回内容签名生成相应的Token即可。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 <span class="number">200</span> OK</div><div class="line"><span class="attribute">Content-Type</span>: application/json</div><div class="line"></div><div class="line"><span class="json">&#123;<span class="attr">"token"</span>: <span class="string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiIsImtpZCI6IlBZWU86VEVXVTpWN0pIOjI2SlY6QVFUWjpMSkMzOlNYVko6WEdIQTozNEYyOjJMQVE6WlJNSzpaN1E2In0.eyJpc3MiOiJhdXRoLmRvY2tlci5jb20iLCJzdWIiOiJqbGhhd24iLCJhdWQiOiJyZWdpc3RyeS5kb2NrZXIuY29tIiwiZXhwIjoxNDE1Mzg3MzE1LCJuYmYiOjE0MTUzODcwMTUsImlhdCI6MTQxNTM4NzAxNSwianRpIjoidFlKQ08xYzZjbnl5N2tBbjBjN3JLUGdiVjFIMWJGd3MiLCJhY2Nlc3MiOlt7InR5cGUiOiJyZXBvc2l0b3J5IiwibmFtZSI6InNhbWFsYmEvbXktYXBwIiwiYWN0aW9ucyI6WyJwdXNoIl19XX0.QhflHPfbd6eVF4lM9bwYpFZIV0PfikbyXuLx959ykRTBpe3CYnzs6YBK8FToVb5R47920PVLrh8zuLzdCr9t3w"</span>, <span class="attr">"expires_in"</span>: <span class="number">3600</span>,<span class="attr">"issued_at"</span>: <span class="string">"2009-11-10T23:00:00Z"</span>&#125;</span></div></pre></td></tr></table></figure>
<p>当docker client获取到token之后，client会将得到的token作为http请求头信息再次尝试访问registry，registry使用公钥解密并验证token内容，并根据token包含的权限信息完成实际的操作</p>
<h2 id="如何生成符合Docker-Registry规范的Json-Web-Token详解"><a href="#如何生成符合Docker-Registry规范的Json-Web-Token详解" class="headerlink" title="如何生成符合Docker Registry规范的Json Web Token详解"></a>如何生成符合Docker Registry规范的Json Web Token详解</h2><p>生成用户加密的公私钥</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">openssl req -newkey rsa:<span class="number">4096</span> -nodes -sha256 -keyout auth.key -x509 -days <span class="number">365</span> -out auth.crt</div><div class="line">Generating a <span class="number">4096</span> bit RSA private key</div><div class="line">................................................................................................................................................................................................................++</div><div class="line">........................................................................++</div><div class="line">writing new private key to <span class="string">'auth.key'</span></div><div class="line">-----</div><div class="line">You are about to be asked to enter information that will be incorporated</div><div class="line">into your certificate request.</div><div class="line">What you are about to enter is what is called a Distinguished Name or a DN.</div><div class="line">There are quite a few fields but you can leave some blank</div><div class="line">For some fields there will be a default value,</div><div class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</div><div class="line">-----</div><div class="line">Country Name (<span class="number">2</span> letter <span class="keyword">code</span>) [AU]:DE</div><div class="line">State or Province Name (full name) [Some-State]:Example State</div><div class="line">Locality Name (eg, city) []:Example City</div><div class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:Example Company</div><div class="line">Organizational Unit Name (eg, section) []:Example Organizational Unit</div><div class="line">Common Name (e.g. server FQDN or YOUR name) []:auth.example.com</div><div class="line">Email Address []:admin@auth.example.com</div></pre></td></tr></table></figure>
<p>此时我们将得到两个文件加密文件auth.cert和auth.key</p>
<h3 id="Docker-Registry端"><a href="#Docker-Registry端" class="headerlink" title="Docker Registry端"></a>Docker Registry端</h3><p>auth.cert对应docker registry的auth.token.rootcertbundle配置项，用户验证docker client请求时提供的token是否合法</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">auth:</span></div><div class="line"><span class="symbol">  token:</span></div><div class="line"><span class="symbol">    realm:</span> http:<span class="comment">//172.16.137.217:8080/auth</span></div><div class="line"><span class="symbol">    service:</span> Docker registry</div><div class="line"><span class="symbol">    issuer:</span> Auth Service</div><div class="line"><span class="symbol">    rootcertbundle:</span> <span class="meta-keyword">/certs/</span>auth.crt</div></pre></td></tr></table></figure>
<h3 id="Auth-Server端"><a href="#Auth-Server端" class="headerlink" title="Auth Server端"></a>Auth Server端</h3><p>当Auth Server拦截到到认证请求</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">http:</span>//<span class="number">172.16</span><span class="meta">.137</span><span class="meta">.217</span>:<span class="number">8080</span>/auth?service=Docker registry&amp;scope=repository:samalba/my-app:pull,<span class="keyword">push</span></div></pre></td></tr></table></figure>
<p>根据请求信息验证授权完成之后，我们将根据以下规则生成json web token内容。</p>
<p>生成token主要由3个部分组成：</p>
<ol>
<li>生成jwt的Header信息</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"typ"</span>: <span class="string">"JWT"</span>,</div><div class="line">    <span class="attr">"alg"</span>: <span class="string">"ES256"</span>,</div><div class="line">    <span class="attr">"kid"</span>: <span class="string">"PYYO:TEWU:V7JH:26JV:AQTZ:LJC3:SXVJ:XGHA:34F2:2LAQ:ZRMK:Z7Q6"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>typ: 当使用JWT时，typ固定为“JWT”</li>
<li>alg: 对应私钥文件的加密方式，本示例中即对应auth.key文件的加密方式，可以通过代码读取私钥文件获取</li>
<li>kid: 根据docker提供的规则生成公钥文件的kid,registry会根据同样的算法获取公钥的kid,如果匹配失败则认证失败</li>
</ul>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- Take <span class="keyword">the</span> DER encoded public key which <span class="keyword">the</span> JWT <span class="keyword">token</span> was signed against.</div><div class="line">- Create <span class="keyword">a</span> SHA256 hash out <span class="keyword">of</span> <span class="keyword">it</span> <span class="keyword">and</span> truncate <span class="built_in">to</span> <span class="number">240</span>bits.</div><div class="line">- Split <span class="keyword">the</span> <span class="built_in">result</span> <span class="keyword">into</span> <span class="number">12</span> base32 encoded groups <span class="keyword">with</span> : <span class="keyword">as</span> delimiter.</div></pre></td></tr></table></figure>
<blockquote>
<p>对于基于golang开发的同学而言可以直接使用<a href="https://github.com/docker/libtrust/blob/master/key.go提供的KeyID方法获取公钥的keyid" target="_blank" rel="external">https://github.com/docker/libtrust/blob/master/key.go提供的KeyID方法获取公钥的keyid</a></p>
</blockquote>
<ol>
<li>设置jwt的payload信息Claim Set</li>
</ol>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"iss"</span>: <span class="string">"Auth Service"</span>, <span class="comment">//需要注意必须与auth.token.issuer配置保持一致</span></div><div class="line">    <span class="string">"sub"</span>: <span class="string">"some id"</span>, <span class="comment">//根据业务系统的规则自定义生成即可</span></div><div class="line">    <span class="string">"aud"</span>: <span class="string">"Docker registry"</span>,<span class="comment">// 从请求的service参数获取</span></div><div class="line">    <span class="string">"exp"</span>: <span class="number">1415387315</span>, <span class="comment">//过期时间</span></div><div class="line">    <span class="string">"nbf"</span>: <span class="number">1415387015</span>, <span class="comment">// not before 可选参数</span></div><div class="line">    <span class="string">"iat"</span>: <span class="number">1415387015</span>, <span class="comment">// 正式发行时间</span></div><div class="line">    <span class="string">"jti"</span>: <span class="string">"tYJCO1c6cnyy7kAn0c7rKPgbV1H1bFws"</span>, <span class="comment">//随机生成即可</span></div><div class="line">    <span class="comment">// access根据请求的scope获取，当然业务系统要判断用户的实际权限并在actions中放回</span></div><div class="line">    <span class="string">"access"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"type"</span>: <span class="string">"repository"</span>,</div><div class="line">            <span class="string">"name"</span>: <span class="string">"samalba/my-app"</span>,</div><div class="line">            <span class="string">"actions"</span>: [</div><div class="line">                <span class="string">"pull"</span>,</div><div class="line">                <span class="string">"push"</span></div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3,最后使用auth.key私钥进行签名</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">RSASHA256(</div><div class="line">  <span class="name">base64UrlEncode</span>(<span class="name">header</span>) + <span class="string">"."</span> +</div><div class="line">  base64UrlEncode(<span class="name">payload</span>),</div><div class="line">  'auth.key file content'  </div><div class="line">)</div></pre></td></tr></table></figure>
<p>从代码来看应该更容易理解</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; header = getJWTHeader();</div><div class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; claims = getJWTClaims();</div><div class="line"></div><div class="line"><span class="keyword">return</span> Jwts.builder()</div><div class="line">            .setHeader(header)</div><div class="line">            .setClaims(claims)</div><div class="line">            .signWith(SignatureAlgorithm.RS256,getPrivateKey());</div></pre></td></tr></table></figure>
<h2 id="代码实现简化版"><a href="#代码实现简化版" class="headerlink" title="代码实现简化版"></a>代码实现简化版</h2><p>添加Endpoint用于响应docker client认证请求</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistryAuthController</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> RegistryAuthServer registryAuthServer;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping(<span class="meta-string">"/auth"</span>)</span></div><div class="line">    <span class="keyword">public</span> ResponseEntity auth(<span class="keyword">final</span> HttpServletRequest request) &#123;</div><div class="line">        <span class="keyword">return</span> ResponseEntity.ok(registryAuthServer.auth(request));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>添加RegistryAuthServer实现授权验证以及生成Token令牌</p>
<blockquote>
<p>备注：作为示例keyid我们直接使用docker提供的libtrust库从公钥文件生成，另外代码中的硬编码，字符常量请忽略~just demo..</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">@Component</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> RegistryAuthServer &#123;</div><div class="line"></div><div class="line">   <span class="keyword">public</span> RegistryTokenResponse auth(HttpServletRequest request) &#123;</div><div class="line">        <span class="keyword">String</span> token = getDefaultJwtToken(request.getParameter(<span class="string">"client_id"</span>),</div><div class="line">                request.getParameter(<span class="string">"service"</span>),</div><div class="line">                getAccess(request.getParameter(<span class="string">"scope"</span>))).compact();</div><div class="line">        <span class="built_in">return</span> <span class="keyword">new</span> RegistryTokenResponse(token);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;AccessScope&gt; getAccess(<span class="keyword">String</span> scope) &#123;</div><div class="line">        <span class="built_in">return</span> Strings.isNullOrEmpty(scope) ?</div><div class="line">                Collections.EMPTY_LIST : Collections.singletonList(<span class="keyword">new</span> AccessScope(scope));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> JwtBuilder getDefaultJwtToken(<span class="keyword">String</span> clientId, <span class="keyword">String</span> service, List&lt;AccessScope&gt; access) &#123;</div><div class="line">        <span class="built_in">try</span> &#123;</div><div class="line">            <span class="built_in">return</span> Jwts.builder()</div><div class="line">                    .setHeader(getJWTHeader())</div><div class="line">                    .setClaims(getDefaultClaims(clientId, service, access))</div><div class="line">                    .signWith(SignatureAlgorithm.RS256, getPrivateKey());</div><div class="line"></div><div class="line">        &#125; <span class="built_in">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceRuntimeException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Map&lt;<span class="keyword">String</span>, Object&gt; getDefaultClaims(<span class="keyword">String</span> clientId, <span class="keyword">String</span> service, List&lt;AccessScope&gt; access) &#123;</div><div class="line">        Map&lt;<span class="keyword">String</span>, Object&gt; claims = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        claims.<span class="built_in">put</span>(<span class="string">"access"</span>, access);</div><div class="line">        claims.<span class="built_in">put</span>(<span class="string">"iss"</span>, <span class="string">"Auth Service"</span>);</div><div class="line">        claims.<span class="built_in">put</span>(<span class="string">"sub"</span>, clientId);</div><div class="line">        claims.<span class="built_in">put</span>(<span class="string">"aud"</span>, service);</div><div class="line">        claims.<span class="built_in">put</span>(<span class="string">"exp"</span>, <span class="keyword">new</span> Date(DateTime.now().plusDays(<span class="number">7</span>).getMillis()));</div><div class="line">        claims.<span class="built_in">put</span>(<span class="string">"iat"</span>, <span class="keyword">new</span> Date());</div><div class="line">        claims.<span class="built_in">put</span>(<span class="string">"jti"</span>, <span class="string">"jwtid"</span>);</div><div class="line">        <span class="built_in">return</span> claims;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> HashMap&lt;<span class="keyword">String</span>, Object&gt; getJWTHeader() throws Exception &#123;</div><div class="line">        PrivateKey privateKey = <span class="keyword">this</span>.getPrivateKey();</div><div class="line">        HashMap&lt;<span class="keyword">String</span>, Object&gt; header = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        header.<span class="built_in">put</span>(<span class="string">"typ"</span>, <span class="string">"JWT"</span>);</div><div class="line">        header.<span class="built_in">put</span>(<span class="string">"alg"</span>, privateKey.getAlgorithm());</div><div class="line">        header.<span class="built_in">put</span>(<span class="string">"kid"</span>, getPublicKeyId());</div><div class="line">        <span class="built_in">return</span> header;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">protected</span> PublicKey getPublicCertKey() throws Exception &#123;</div><div class="line">        <span class="keyword">byte</span>[] keyBytes = DatatypeConverter</div><div class="line">                .parseBase64Binary(<span class="keyword">new</span> <span class="keyword">String</span>(formatPublicKey(<span class="string">"auth.crt"</span>).getBytes(), Charset.forName(<span class="string">"UTF-8"</span>)));</div><div class="line">        <span class="built_in">return</span> CertificateFactory.getInstance(<span class="string">"X509"</span>).generateCertificate(<span class="keyword">new</span> ByteArrayInputStream(keyBytes)).getPublicKey();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> PrivateKey getPrivateKey() throws Exception &#123;</div><div class="line">        java.security.Security.addProvider(<span class="keyword">new</span> org.bouncycastle.jce.provider.BouncyCastleProvider());</div><div class="line">        <span class="keyword">byte</span>[] keyBytes = <span class="keyword">new</span> Base64().decode(formatPrivateKey(getResourceBytes(<span class="string">"auth.key"</span>)));</div><div class="line">        <span class="built_in">return</span> KeyFactory.getInstance(<span class="string">"RSA"</span>).generatePrivate(<span class="keyword">new</span> PKCS8EncodedKeySpec(keyBytes));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">String</span> formatPrivateKey(<span class="keyword">byte</span>[] keyBytes) throws UnsupportedEncodingException &#123;</div><div class="line">        <span class="built_in">return</span> <span class="keyword">new</span> <span class="keyword">String</span>(keyBytes, <span class="string">"UTF-8"</span>)</div><div class="line">                .replaceAll(<span class="string">"(-+BEGIN RSA PRIVATE KEY-+\\r?\\n|-+END RSA PRIVATE KEY-+\\r?\\n?)"</span>, <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">String</span> formatPublicKey(<span class="keyword">String</span> resources) throws IOException &#123;</div><div class="line">        <span class="built_in">return</span> <span class="keyword">new</span> <span class="keyword">String</span>(getResourceBytes(resources), <span class="string">"UTF-8"</span>)</div><div class="line">                .replaceAll(<span class="string">"(-+BEGIN CERTIFICATE-+\\r?\\n|-+END CERTIFICATE-+\\r?\\n?)"</span>, <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">String</span> getPublicKeyId() &#123;</div><div class="line">        <span class="built_in">return</span> <span class="string">"MXNV:KLDD:GEH3:DWME:7CTG:E2HZ:QJDM:LJXI:35NL:FZZ3:LPE2:IOKY"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] getResourceBytes(<span class="keyword">String</span> publicCertKeyFileName) throws IOException &#123;</div><div class="line">        ClassPathResource classPathResource = <span class="keyword">new</span> ClassPathResource(publicCertKeyFileName);</div><div class="line">        <span class="built_in">File</span> file = classPathResource.getFile();</div><div class="line">        FileInputStream in = <span class="keyword">new</span> FileInputStream(file);</div><div class="line">        <span class="keyword">byte</span>[] keyBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[in.<span class="built_in">available</span>()];</div><div class="line">        in.<span class="built_in">read</span>(keyBytes);</div><div class="line">        in.<span class="built_in">close</span>();</div><div class="line">        <span class="built_in">return</span> keyBytes;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://docs.docker.com/registry/spec/auth/token/" target="_blank" rel="external">https://docs.docker.com/registry/spec/auth/token/</a></li>
<li><a href="https://github.com/docker/distribution/blob/master/docs/spec/auth/token.md" target="_blank" rel="external">https://github.com/docker/distribution/blob/master/docs/spec/auth/token.md</a></li>
<li><a href="https://docs.docker.com/registry/configuration/" target="_blank" rel="external">https://docs.docker.com/registry/configuration/</a></li>
<li><a href="https://github.com/cesanta/docker_auth" target="_blank" rel="external">https://github.com/cesanta/docker_auth</a></li>
<li><a href="https://github.com/kwk/docker-registry-setup" target="_blank" rel="external">https://github.com/kwk/docker-registry-setup</a></li>
</ul>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/yunlzheng" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2016 云龙<br></p>
                <p class="copyright text-muted">Powerby <a target="_blank" href="https://hexo.io/">Hexo</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>
